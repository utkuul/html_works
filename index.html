<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>BorÃ§ ve Harcama Takip Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-alt: #111827;
      --card: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --border: #1f2933;
      --radius-lg: 1rem;
      --radius-md: .6rem;
      --shadow-soft: 0 18px 40px rgba(0,0,0,0.48);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2rem;
      letter-spacing: .04em;
      margin: 0 0 4px;
    }

    .subtitle {
      color: var(--muted);
      font-size: .9rem;
      margin-bottom: 24px;
    }

    .grid {
      display: grid;
      gap: 18px;
    }

    @media (min-width: 900px) {
      .grid-2 {
        grid-template-columns: 1.4fr 1fr;
      }
      .grid-2-compact {
        grid-template-columns: 1.2fr 1fr;
      }
    }

    .card {
      background: radial-gradient(circle at top left, #020617, #020617 40%, #020617 80%);
      border-radius: var(--radius-lg);
      padding: 18px 18px 16px;
      border: 1px solid rgba(148, 163, 184, 0.16);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      opacity: .16;
      background:
        radial-gradient(circle at 10% 10%, rgba(34, 197, 94, 0.3) 0, transparent 35%),
        radial-gradient(circle at 80% 100%, rgba(56, 189, 248, 0.28) 0, transparent 40%);
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .card-desc {
      color: var(--muted);
      font-size: .8rem;
    }

    .badge {
      border-radius: 999px;
      padding: 3px 10px;
      font-size: .7rem;
      border: 1px solid rgba(148,163,184,0.26);
      color: var(--muted);
      white-space: nowrap;
    }

    .badge-accent {
      border-color: rgba(34,197,94,0.7);
      background: var(--accent-soft);
      color: #bbf7d0;
    }

    .summary-row {
      display: flex;
      gap: 10px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .pill {
      flex: 1;
      min-width: 150px;
      border-radius: var(--radius-md);
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.2);
      padding: 10px 12px;
    }

    .pill-label {
      font-size: .7rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: .05em;
      margin-bottom: 3px;
    }

    .pill-value {
      font-size: 1rem;
      font-weight: 600;
    }

    .pill-value-small {
      font-size: .8rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .pill--accent {
      border-color: rgba(34,197,94,0.5);
      background: var(--accent-soft);
    }

    .pill--danger {
      border-color: rgba(248,113,113,0.65);
      background: rgba(248,113,113,0.12);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 8px;
      margin-top: 10px;
    }

    .form-grid-compact {
      grid-template-columns: repeat(3, minmax(0,1fr));
    }

    @media (max-width: 900px) {
      .form-grid,
      .form-grid-compact {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: .8rem;
    }

    label {
      color: var(--muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
      border-radius: .45rem;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      padding: 6px 9px;
      color: var(--text);
      font-size: .8rem;
      outline: none;
    }

    input::placeholder {
      color: rgba(148,163,184,0.7);
    }

    input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.3);
    }

    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      border: none;
      cursor: pointer;
      font-size: .8rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #ef4444, #f97316);
      color: #fff;
      box-shadow: 0 10px 25px rgba(239,68,68,0.4);
      margin-top: auto;
      white-space: nowrap;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.08s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(239,68,68,0.55);
      opacity: 0.97;
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(0,0,0,0.6);
      opacity: 0.9;
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      box-shadow: none;
    }

    .btn-sm {
      padding: 3px 9px;
      font-size: .75rem;
    }

    .btn-icon {
      font-size: .9rem;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: .8rem;
    }

    .table thead {
      background: rgba(15,23,42,0.9);
    }

    .table th,
    .table td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(31,41,55,0.9);
    }

    .table th {
      font-size: .7rem;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--muted);
      white-space: nowrap;
    }

    .table tr:last-child td {
      border-bottom: none;
    }

    .tag {
      font-size: .7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--muted);
      background: rgba(15,23,42,0.9);
      white-space: nowrap;
    }

    .tag-cc {
      border-color: rgba(59,130,246,0.7);
      color: #bfdbfe;
      background: rgba(59,130,246,0.15);
    }

    .tag-loan {
      border-color: rgba(248,113,113,0.7);
      color: #fecaca;
      background: rgba(248,113,113,0.15);
    }

    .tag-other {
      border-color: rgba(244,114,182,0.7);
      color: #fbcfe8;
      background: rgba(244,114,182,0.15);
    }

    .muted {
      color: var(--muted);
      font-size: .8rem;
    }

    .expense-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .expense-form {
      margin-top: 8px;
      border-radius: var(--radius-md);
      padding: 10px;
      background: rgba(15,23,42,0.92);
      border: 1px dashed rgba(148,163,184,0.5);
    }

    .expense-list {
      margin-top: 10px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .expense-item {
      display: grid;
      grid-template-columns: 1.2fr 0.7fr 0.7fr;
      gap: 6px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(31,41,55,0.9);
      font-size: .8rem;
    }

    .expense-item:last-child {
      border-bottom: none;
    }

    .expense-amount {
      text-align: right;
      font-weight: 600;
    }

    .expense-date {
      text-align: right;
      color: var(--muted);
      font-size: .75rem;
    }

    .pill-alert {
      font-size: .75rem;
      margin-top: 8px;
      padding: 6px 8px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(251,191,36,0.7);
      background: rgba(251,191,36,0.12);
      color: #fbbf24;
    }

    .text-danger {
      color: var(--danger);
      font-weight: 600;
    }

    .text-accent {
      color: var(--accent);
      font-weight: 600;
    }

    .footer-note {
      margin-top: 14px;
      font-size: .75rem;
      color: var(--muted);
      text-align: right;
    }

    .sim-result {
      margin-top: 10px;
      font-size: .8rem;
      border-radius: var(--radius-md);
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.3);
      padding: 10px;
    }

    .sim-list {
      margin-top: 6px;
    }

    .sim-item {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(31,41,55,0.8);
    }

    .sim-item:last-child {
      border-bottom: none;
    }

    .sim-main {
      font-weight: 500;
    }

    .sim-sub {
      color: var(--muted);
      font-size: .75rem;
    }

    .sim-highlight {
      font-weight: 600;
    }

    hr.divider {
      border: none;
      border-top: 1px solid rgba(31,41,55,0.9);
      margin: 14px 0 8px;
    }

    @media (max-width: 600px) {
      body {
        padding: 14px;
      }
      .card {
        padding: 14px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>BorÃ§ & Harcama Takip Paneli</h1>
      <div class="subtitle">
        Kredi kartÄ± ve kredi borÃ§larÄ±nÄ± tek ekranda gÃ¶r, aylÄ±k Ã¶demelerini planla, yeni harcamalarÄ±nÄ± anÄ±nda ekle.
      </div>
    </header>

    <div class="grid grid-2">
      <!-- SOL TARAF: Ã–ZET + VADELÄ° -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">Genel Ã–zet</div>
              <div class="card-desc">Toplam borÃ§, bu ayki minimum Ã¶deme ve borÃ§ / gelir oranÄ±.</div>
            </div>
            <span class="badge badge-accent" id="currentMonthLabel">Bu Ay</span>
          </div>

          <div class="summary-row">
            <div class="pill pill--danger">
              <div class="pill-label">Toplam BorÃ§</div>
              <div class="pill-value" id="totalDebtText">â‚º0</div>
              <div class="pill-value-small" id="debtCountText">0 kalem borÃ§</div>
            </div>
            <div class="pill">
              <div class="pill-label">Bu Ay Ã–deme (Min.)</div>
              <div class="pill-value" id="monthlyPaymentText">â‚º0</div>
              <div class="pill-value-small" id="dueSoonText">Son Ã¶deme gÃ¼nleri iÃ§in aÅŸaÄŸÄ±ya bak</div>
            </div>
            <div class="pill">
              <div class="pill-label">AylÄ±k Net Gelirin</div>
              <div class="pill-value" id="incomeText">â‚º0</div>
              <div class="pill-value-small">BorÃ§ / Gelir: <span id="debtIncomeRatio">0%</span></div>
            </div>
          </div>

          <form id="incomeForm" style="margin-top: 12px; display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap;">
            <div class="input-group" style="min-width:150px;">
              <label for="incomeInput">AylÄ±k net gelir (opsiyonel)</label>
              <input type="number" id="incomeInput" placeholder="Ã–rn: 25000" min="0" step="0.01" />
            </div>
            <button type="submit" class="btn btn-sm">
              <span class="btn-icon">ğŸ’¾</span>
              Geliri Kaydet
            </button>
            <span class="muted">Sadece borÃ§ / gelir oranÄ± hesaplamak iÃ§in.</span>
          </form>

          <hr class="divider" />

          <!-- VADELÄ° MEVDUAT -->
          <div class="card-header" style="margin-top:0; padding-top:0;">
            <div>
              <div class="card-title">Vadeli Mevduat</div>
              <div class="card-desc">
                Vadeli hesabÄ±ndaki anaparayÄ± ve yÄ±llÄ±k faiz oranÄ±nÄ± gir; bu ay sonunda ulaÅŸacaÄŸÄ± tutarÄ± ve gÃ¼nlÃ¼k kazancÄ± gÃ¶r.
              </div>
            </div>
          </div>

          <form id="termDepositForm" style="display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end;">
            <div class="input-group" style="min-width:140px;">
              <label for="termBalanceInput">Vadeli bakiye (â‚º)</label>
              <input type="number" id="termBalanceInput" min="0" step="0.01" placeholder="Ã–rn: 50000" />
            </div>
            <div class="input-group" style="min-width:140px;">
              <label for="termRateInput">YÄ±llÄ±k faiz oranÄ± (%)</label>
              <input type="number" id="termRateInput" min="0" step="0.01" placeholder="Ã–rn: 45" />
            </div>
            <button type="submit" class="btn btn-sm">
              <span class="btn-icon">ğŸ’¾</span>
              Vadeli Bilgilerini Kaydet
            </button>
          </form>

          <div class="summary-row" style="margin-top:10px;">
            <div class="pill pill--accent">
              <div class="pill-label">Bu ay sonu tahmini bakiye</div>
              <div class="pill-value" id="termMonthEndText">â‚º0</div>
              <div class="pill-value-small">Basit hesap: yÄ±llÄ±k faiz / 12 ile</div>
            </div>
            <div class="pill">
              <div class="pill-label">GÃ¼nlÃ¼k yaklaÅŸÄ±k kazanÃ§</div>
              <div class="pill-value" id="termDailyInterestText">â‚º0</div>
              <div class="pill-value-small">YÄ±llÄ±k faiz / 365â€™e gÃ¶re yaklaÅŸÄ±k</div>
            </div>
          </div>
        </div>
      </section>

      <!-- SAÄ TARAF: GÃœNLÃœK HARCAMALAR -->
      <section class="card">
        <div class="card-inner">
          <div class="expense-header">
            <div>
              <div class="card-title">GÃ¼nlÃ¼k Harcamalar</div>
              <div class="card-desc">â€œYeni harcama yaptÄ±mâ€ dediÄŸinde buradan ekle. Taksitli alÄ±ÅŸveriÅŸleri de girebilirsin.</div>
            </div>
            <button id="toggleExpenseFormBtn" class="btn btn-sm">
              <span class="btn-icon">â•</span>
              Yeni harcama yaptÄ±m
            </button>
          </div>

          <div id="expenseFormContainer" class="expense-form" style="display:none;">
            <form id="expenseForm">
              <div class="form-grid">
                <div class="input-group">
                  <label for="expenseDescription">AÃ§Ä±klama</label>
                  <input type="text" id="expenseDescription" placeholder="Market, akaryakÄ±t, online alÄ±ÅŸveriÅŸ..." />
                </div>
                <div class="input-group">
                  <label for="expenseAmount">Tutar (â‚º)</label>
                  <input type="number" id="expenseAmount" min="0" step="0.01" required />
                </div>
                <div class="input-group">
                  <label for="expenseInstallmentsCount">Taksit sayÄ±sÄ± (opsiyonel)</label>
                  <input type="number" id="expenseInstallmentsCount" min="1" step="1" placeholder="Ã–rn: 6" />
                </div>
                <div class="input-group">
                  <label for="expenseDebtSelect">Hangi kart / kredi?</label>
                  <select id="expenseDebtSelect" required>
                    <option value="">SeÃ§iniz</option>
                  </select>
                </div>
                <div class="input-group">
                  <label for="expenseDate">Tarih</label>
                  <input type="date" id="expenseDate" />
                </div>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px; gap:8px; flex-wrap:wrap;">
                <button type="submit" class="btn btn-sm">
                  <span class="btn-icon">âœ…</span>
                  HarcamayÄ± Ekle
                </button>
                <button type="button" id="cancelExpenseBtn" class="btn btn-sm btn-ghost">Ä°ptal</button>
                <span class="muted">
                  Taksitli harcamalarda toplam tutar borÃ§ bakiyene eklenir,
                  not olarak taksit sayÄ±sÄ± kaydedilir.
                </span>
              </div>
            </form>
          </div>

          <div class="expense-list" id="expenseList"></div>
          <div class="pill-alert" id="expenseSummaryAlert" style="display:none;"></div>
        </div>
      </section>
    </div>

    <div class="grid grid-2-compact" style="margin-top:18px;">
      <!-- BORÃ‡ KARTLARI -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">Kart ve Kredi Listesi</div>
              <div class="card-desc">Her kart / kredinin kalan borcu, aylÄ±k Ã¶demesi, faiz ve taksit bilgisi.</div>
            </div>
            <span class="badge">Maksimum kontrol iÃ§in detaylÄ± liste</span>
          </div>

          <form id="debtForm">
            <div class="form-grid form-grid-compact">
              <div class="input-group">
                <label for="debtName">AdÄ±</label>
                <input type="text" id="debtName" placeholder="Ã–rn: Akbank Axess, Ä°htiyaÃ§ Kredisi" required />
              </div>
              <div class="input-group">
                <label for="debtType">TÃ¼rÃ¼</label>
                <select id="debtType">
                  <option value="creditCard">Kredi KartÄ±</option>
                  <option value="loan">Kredi</option>
                  <option value="other">DiÄŸer</option>
                </select>
              </div>
              <div class="input-group">
                <label for="debtBalance">Kalan BorÃ§ (â‚º)</label>
                <input type="number" id="debtBalance" min="0" step="0.01" required />
              </div>
              <div class="input-group">
                <label for="debtMonthlyPayment">AylÄ±k Ã–deme (min)</label>
                <input type="number" id="debtMonthlyPayment" min="0" step="0.01" required />
              </div>
              <div class="input-group">
                <label for="debtInterestRate">AylÄ±k Faiz OranÄ± (%)</label>
                <input type="number" id="debtInterestRate" min="0" step="0.01" placeholder="Ã–rn: 2.5" />
              </div>
              <div class="input-group">
                <label for="debtInstallments">Kalan Taksit SayÄ±sÄ±</label>
                <input type="number" id="debtInstallments" min="0" step="1" placeholder="Opsiyonel" />
              </div>
              <div class="input-group">
                <label for="debtDueDay">Son Ã¶deme gÃ¼nÃ¼ (1-31)</label>
                <input type="number" id="debtDueDay" min="1" max="31" placeholder="Ã–rn: 10" />
              </div>
              <div class="input-group" style="align-self:flex-end;">
                <button type="submit" class="btn btn-sm">
                  <span class="btn-icon">â•</span>
                  BorÃ§ Ekle / GÃ¼ncelle
                </button>
              </div>
            </div>
          </form>

          <div style="overflow-x:auto;">
            <table class="table" id="debtTable">
              <thead>
                <tr>
                  <th>Ad</th>
                  <th>TÃ¼r</th>
                  <th>Kalan BorÃ§</th>
                  <th>AylÄ±k Ã–deme</th>
                  <th>Faiz (aylÄ±k %)</th>
                  <th>Kalan Taksit</th>
                  <th>Son GÃ¼n</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <!-- JS ile doldurulacak -->
              </tbody>
            </table>
          </div>

          <div class="pill-alert" id="dueWarning" style="display:none;"></div>
        </div>
      </section>

      <!-- FAÄ°Z & SÄ°MÃœLASYON + AVALANCHE -->
      <section class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">â€œÅu tarihe kadar borÃ§suz kalâ€ simÃ¼lasyonu</div>
              <div class="card-desc">SeÃ§tiÄŸin tarihe kadar borÃ§suz kalmak iÃ§in aylÄ±k ne kadar Ã¶demen gerektiÄŸini hesaplar.</div>
            </div>
            <span class="badge">Basit finans simÃ¼latÃ¶rÃ¼</span>
          </div>

          <form id="simForm">
            <div class="form-grid form-grid-compact">
              <div class="input-group">
                <label for="simDebtSelect">Hangi borÃ§?</label>
                <select id="simDebtSelect">
                  <option value="all">TÃ¼m borÃ§lar</option>
                </select>
              </div>
              <div class="input-group">
                <label for="simTargetDate">Hedef tarih</label>
                <input type="date" id="simTargetDate" required />
              </div>
              <div class="input-group">
                <label>&nbsp;</label>
                <button type="submit" class="btn btn-sm">
                  <span class="btn-icon">ğŸ“…</span>
                  SimÃ¼lasyonu Ã‡alÄ±ÅŸtÄ±r
                </button>
              </div>
            </div>
          </form>

          <div id="simResult" class="sim-result" style="display:none;"></div>

          <hr class="divider" />

          <div class="card-header" style="margin-top:0; padding-top:0;">
            <div>
              <div class="card-title">Avalanche Ã¶nerisi</div>
              <div class="card-desc">
                Faiz oranÄ± en yÃ¼ksek olandan baÅŸlayarak hangi borcu Ã¶nce kapatmanÄ±n daha mantÄ±klÄ± olduÄŸunu sÄ±ralar.
              </div>
            </div>
          </div>

          <div id="avalancheResult" class="sim-result"></div>
        </div>
      </section>
    </div>

    <div class="footer-note">
      Not: Bu sayfa sadece kiÅŸisel takip iÃ§indir, resmi finansal tavsiye yerine geÃ§mez.
    </div>
  </div>

  <script>
    // --- Basit state yÃ¶netimi ---
    const STORAGE_KEY = "borc_takip_v1";

    const state = {
      income: 0,
      debts: [],
      expenses: [],
      termDeposit: {
        balance: 0,
        annualRate: 0
      }
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const data = JSON.parse(raw);
          state.income = data.income || 0;
          state.debts = (data.debts || []).map(d => ({
            ...d,
            interestRate: d.interestRate || 0,
            remainingInstallments: d.remainingInstallments || null
          }));
          state.expenses = data.expenses || [];
          state.termDeposit = data.termDeposit || { balance: 0, annualRate: 0 };
        }
      } catch (e) {
        console.error("State okunamadÄ±", e);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // --- YardÄ±mcÄ±lar ---
    function formatCurrency(amount) {
      if (isNaN(amount)) return "â‚º0";
      return "â‚º" + amount.toLocaleString("tr-TR", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function getDebtTypeTag(type) {
      if (type === "creditCard") return { text: "Kredi KartÄ±", cls: "tag tag-cc" };
      if (type === "loan") return { text: "Kredi", cls: "tag tag-loan" };
      return { text: "DiÄŸer", cls: "tag tag-other" };
    }

    function todayISO() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }

    function updateCurrentMonthLabel() {
      const label = document.getElementById("currentMonthLabel");
      const d = new Date();
      const months = ["Ocak","Åubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
      label.textContent = months[d.getMonth()] + " " + d.getFullYear();
    }

    function monthsBetweenNowAnd(dateStr) {
      const now = new Date();
      const target = new Date(dateStr);
      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const end = new Date(target.getFullYear(), target.getMonth(), target.getDate());
      if (end <= start) return 0;

      let months =
        (end.getFullYear() - start.getFullYear()) * 12 +
        (end.getMonth() - start.getMonth());

      if (end.getDate() > start.getDate()) {
        months += 1;
      }
      if (months < 1) months = 1;
      return months;
    }

    // --- Vadeli mevduat render ---
    function renderTermDeposit() {
      const balance = state.termDeposit?.balance || 0;
      const annualRate = state.termDeposit?.annualRate || 0;

      const balanceInput = document.getElementById("termBalanceInput");
      const rateInput = document.getElementById("termRateInput");
      const monthEndText = document.getElementById("termMonthEndText");
      const dailyText = document.getElementById("termDailyInterestText");

      if (balanceInput) balanceInput.value = balance || "";
      if (rateInput) rateInput.value = annualRate || "";

      let monthlyRate = 0;
      if (annualRate > 0) {
        monthlyRate = (annualRate / 100) / 12;
      }
      const monthEndBalance = balance * (1 + monthlyRate);
      const dailyInterest = annualRate > 0 ? (balance * (annualRate / 100)) / 365 : 0;

      if (monthEndText) monthEndText.textContent = formatCurrency(isFinite(monthEndBalance) ? monthEndBalance : 0);
      if (dailyText) dailyText.textContent = formatCurrency(isFinite(dailyInterest) ? dailyInterest : 0);
    }

    // --- Genel Ã¶zet render ---
    function renderSummary() {
      const totalDebt = state.debts.reduce((sum, d) => sum + (d.balance || 0), 0);
      const totalMonthly = state.debts.reduce((sum, d) => sum + (d.monthlyPayment || 0), 0);

      document.getElementById("totalDebtText").textContent = formatCurrency(totalDebt);
      document.getElementById("monthlyPaymentText").textContent = formatCurrency(totalMonthly);
      document.getElementById("debtCountText").textContent = state.debts.length + " kalem borÃ§";

      const incomeText = document.getElementById("incomeText");
      const ratioSpan = document.getElementById("debtIncomeRatio");
      incomeText.textContent = formatCurrency(state.income || 0);

      let ratio = 0;
      if (state.income > 0) {
        ratio = (totalMonthly / state.income) * 100;
      }
      ratioSpan.textContent = ratio.toFixed(1) + "%";
      ratioSpan.className = ratio > 50 ? "text-danger" : "text-accent";

      // Son Ã¶deme gÃ¼nÃ¼ uyarÄ±sÄ±
      const dueWarning = document.getElementById("dueWarning");
      const today = new Date().getDate();
      const upcoming = state.debts
        .filter(d => d.dueDay)
        .map(d => ({
          ...d,
          daysLeft: d.dueDay - today
        }))
        .filter(d => d.daysLeft >= 0 && d.daysLeft <= 5)
        .sort((a,b) => a.daysLeft - b.daysLeft);

      if (upcoming.length) {
        const msg = upcoming
          .map(d => `${d.name}: ${d.daysLeft === 0 ? "BUGÃœN" : d.daysLeft + " gÃ¼n iÃ§inde"} (gÃ¼n: ${d.dueDay})`)
          .join(" â€¢ ");
        dueWarning.style.display = "block";
        dueWarning.textContent = "YaklaÅŸan son Ã¶deme gÃ¼nleri: " + msg;
      } else {
        dueWarning.style.display = "none";
      }

      renderTermDeposit();
    }

    function renderDebts() {
      const tbody = document.querySelector("#debtTable tbody");
      tbody.innerHTML = "";

      state.debts.forEach(debt => {
        const tr = document.createElement("tr");
        const typeTag = getDebtTypeTag(debt.type);

        const interestText = debt.interestRate
          ? debt.interestRate.toFixed(2).replace(".", ",") + " %"
          : "-";

        const instText = debt.remainingInstallments != null && debt.remainingInstallments !== ""
          ? debt.remainingInstallments + " ay"
          : "-";

        tr.innerHTML = `
          <td>${debt.name}</td>
          <td><span class="${typeTag.cls}">${typeTag.text}</span></td>
          <td>${formatCurrency(debt.balance)}</td>
          <td>${formatCurrency(debt.monthlyPayment)}</td>
          <td>${interestText}</td>
          <td>${instText}</td>
          <td>${debt.dueDay ? debt.dueDay + ". gÃ¼n" : "-"}</td>
          <td style="text-align:right; white-space:nowrap;">
            <button class="btn btn-sm btn-ghost" data-edit="${debt.id}">DÃ¼zenle</button>
            <button class="btn btn-sm btn-ghost" data-delete="${debt.id}">Sil</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Edit / delete
      tbody.querySelectorAll("button[data-edit]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-edit");
          loadDebtToForm(id);
        });
      });

      tbody.querySelectorAll("button[data-delete]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-delete");
          deleteDebt(id);
        });
      });

      renderSummary();
      populateDebtSelect();
      populateSimDebtSelect();
      renderAvalancheSuggestion();
    }

    function renderExpenses() {
      const list = document.getElementById("expenseList");
      list.innerHTML = "";

      const latest = [...state.expenses].sort((a,b) => b.createdAt - a.createdAt).slice(0, 30);

      if (!latest.length) {
        list.innerHTML = `<div class="muted">HenÃ¼z harcama eklemedin. "Yeni harcama yaptÄ±m" butonuna tÄ±klayarak baÅŸla.</div>`;
      } else {
        latest.forEach(exp => {
          const debt = state.debts.find(d => d.id === exp.debtId);
          const div = document.createElement("div");
          const date = exp.date || exp.displayDate || "";
          const installmentsInfo =
            exp.installmentsCount && exp.installmentsCount > 1
              ? `<div class="muted">${exp.installmentsCount} taksit â€¢ Taksit baÅŸÄ±na ~ ${formatCurrency(exp.amount / exp.installmentsCount)}</div>`
              : "";
          div.className = "expense-item";
          div.innerHTML = `
            <div>
              <div>${exp.description || "(AÃ§Ä±klama yok)"}</div>
              <div class="muted">${debt ? debt.name : "BelirtilmemiÅŸ"}</div>
              ${installmentsInfo}
            </div>
            <div class="expense-amount">${formatCurrency(exp.amount)}</div>
            <div class="expense-date">${date}</div>
          `;
          list.appendChild(div);
        });
      }

      const totalToday = state.expenses
        .filter(e => e.date === todayISO())
        .reduce((sum,e) => sum + (e.amount || 0), 0);

      const alert = document.getElementById("expenseSummaryAlert");
      if (totalToday > 0) {
        alert.style.display = "block";
        alert.textContent = `BugÃ¼n yaptÄ±ÄŸÄ±n harcamalar toplamÄ±: ${formatCurrency(totalToday)} (tarihe gÃ¶re hesaplanÄ±r)`;
      } else {
        alert.style.display = "none";
      }
    }

    function populateDebtSelect() {
      const select = document.getElementById("expenseDebtSelect");
      const previous = select.value;
      select.innerHTML = '<option value="">SeÃ§iniz</option>';

      state.debts.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.name;
        select.appendChild(opt);
      });

      if (state.debts.some(d => d.id === previous)) {
        select.value = previous;
      }
    }

    function populateSimDebtSelect() {
      const select = document.getElementById("simDebtSelect");
      const previous = select.value;
      select.innerHTML = '<option value="all">TÃ¼m borÃ§lar</option>';

      state.debts.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.name;
        select.appendChild(opt);
      });

      if (previous && (previous === "all" || state.debts.some(d => d.id === previous))) {
        select.value = previous;
      }
    }

    // --- CRUD iÅŸlemleri ---
    function upsertDebtFromForm() {
      const name = document.getElementById("debtName").value.trim();
      const type = document.getElementById("debtType").value;
      const balance = parseFloat(document.getElementById("debtBalance").value) || 0;
      const monthlyPayment = parseFloat(document.getElementById("debtMonthlyPayment").value) || 0;
      const interestRateVal = document.getElementById("debtInterestRate").value;
      const interestRate = interestRateVal ? parseFloat(interestRateVal) : 0;
      const dueDayVal = document.getElementById("debtDueDay").value;
      const dueDay = dueDayVal ? parseInt(dueDayVal) : null;
      const instVal = document.getElementById("debtInstallments").value;
      const remainingInstallments = instVal ? parseInt(instVal) : null;

      if (!name) {
        alert("LÃ¼tfen borÃ§ adÄ±nÄ± gir.");
        return;
      }

      const existingIndex = state.debts.findIndex(d => d.name.toLowerCase() === name.toLowerCase());

      if (existingIndex >= 0) {
        // gÃ¼ncelle
        state.debts[existingIndex] = {
          ...state.debts[existingIndex],
          name,
          type,
          balance,
          monthlyPayment,
          interestRate,
          dueDay,
          remainingInstallments
        };
      } else {
        state.debts.push({
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()),
          name,
          type,
          balance,
          monthlyPayment,
          interestRate,
          dueDay,
          remainingInstallments
        });
      }

      saveState();
      renderDebts();
      document.getElementById("debtForm").reset();
    }

    function loadDebtToForm(id) {
      const debt = state.debts.find(d => d.id === id);
      if (!debt) return;

      document.getElementById("debtName").value = debt.name;
      document.getElementById("debtType").value = debt.type;
      document.getElementById("debtBalance").value = debt.balance;
      document.getElementById("debtMonthlyPayment").value = debt.monthlyPayment;
      document.getElementById("debtInterestRate").value = debt.interestRate || "";
      document.getElementById("debtDueDay").value = debt.dueDay || "";
      document.getElementById("debtInstallments").value = debt.remainingInstallments || "";

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function deleteDebt(id) {
      if (!confirm("Bu borcu silmek istediÄŸine emin misin?")) return;
      const index = state.debts.findIndex(d => d.id === id);
      if (index >= 0) {
        state.debts.splice(index, 1);
        saveState();
        renderDebts();
        renderExpenses();
        renderSimulationResult(null);
      }
    }

    function addExpenseFromForm() {
      const description = document.getElementById("expenseDescription").value.trim();
      const amount = parseFloat(document.getElementById("expenseAmount").value) || 0;
      const installmentsVal = document.getElementById("expenseInstallmentsCount").value;
      let installmentsCount = installmentsVal ? parseInt(installmentsVal) : 1;
      if (!installmentsCount || installmentsCount < 1) installmentsCount = 1;

      const debtId = document.getElementById("expenseDebtSelect").value;
      const date = document.getElementById("expenseDate").value || todayISO();

      if (!debtId) {
        alert("LÃ¼tfen harcamayÄ± hangi kart / krediye ekleyeceÄŸini seÃ§.");
        return;
      }
      if (amount <= 0) {
        alert("LÃ¼tfen tutarÄ± 0'dan bÃ¼yÃ¼k gir.");
        return;
      }

      const debt = state.debts.find(d => d.id === debtId);
      if (!debt) {
        alert("SeÃ§ilen kart / kredi bulunamadÄ±.");
        return;
      }

      // BorÃ§ bakiyesine ekle (taksitli de olsa toplam tutar eklenir)
      debt.balance = (debt.balance || 0) + amount;

      // Harcama kaydÄ± ekle
      state.expenses.push({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()),
        description,
        amount,
        debtId,
        date,
        installmentsCount,
        createdAt: Date.now()
      });

      saveState();
      renderDebts();
      renderExpenses();

      document.getElementById("expenseForm").reset();
      document.getElementById("expenseDate").value = todayISO();
    }

    function saveIncomeFromForm() {
      const income = parseFloat(document.getElementById("incomeInput").value) || 0;
      state.income = income;
      saveState();
      renderSummary();
    }

    function saveTermDepositFromForm() {
      const balance = parseFloat(document.getElementById("termBalanceInput").value) || 0;
      const rate = parseFloat(document.getElementById("termRateInput").value) || 0;
      state.termDeposit = { balance, annualRate: rate };
      saveState();
      renderTermDeposit();
    }

    // --- SimÃ¼lasyon ---
    function runSimulationFromForm() {
      const select = document.getElementById("simDebtSelect");
      const targetDateStr = document.getElementById("simTargetDate").value;

      if (!targetDateStr) {
        alert("LÃ¼tfen hedef tarihi seÃ§.");
        return;
      }

      const months = monthsBetweenNowAnd(targetDateStr);
      if (months <= 0) {
        alert("Hedef tarih bugÃ¼nden ileride olmalÄ±.");
        return;
      }

      let debtsToSim = [];
      if (select.value === "all") {
        debtsToSim = state.debts.filter(d => d.balance > 0);
      } else {
        const d = state.debts.find(x => x.id === select.value);
        if (d) debtsToSim = [d];
      }

      if (!debtsToSim.length) {
        alert("SimÃ¼le edilecek borÃ§ bulunamadÄ±.");
        return;
      }

      const results = debtsToSim.map(d => {
        const P = d.balance || 0;
        const r = d.interestRate ? d.interestRate / 100 : 0; // aylÄ±k faiz (Ã¶rn 0.025)
        let payment = 0;
        if (r > 0) {
          const pow = Math.pow(1 + r, -months);
          payment = P * r / (1 - pow);
        } else {
          payment = P / months;
        }
        const totalPaid = payment * months;
        const totalInterest = Math.max(totalPaid - P, 0);
        return {
          debt: d,
          monthlyPaymentNeeded: payment,
          totalInterest,
          months
        };
      });

      renderSimulationResult(results);
    }

    function renderSimulationResult(results) {
      const container = document.getElementById("simResult");
      if (!results || !results.length) {
        container.style.display = "none";
        container.innerHTML = "";
        return;
      }

      const months = results[0].months;
      const totalMonthlyNeeded = results.reduce((sum,r) => sum + r.monthlyPaymentNeeded, 0);
      const totalInterest = results.reduce((sum,r) => sum + r.totalInterest, 0);

      container.style.display = "block";
      container.innerHTML = `
        <div class="sim-main">
          SeÃ§ilen borÃ§(lar)Ä± <span class="sim-highlight">${months} ay</span> iÃ§inde bitirmek iÃ§in
          toplam aylÄ±k Ã¶demen gereken tutar: <span class="sim-highlight">${formatCurrency(totalMonthlyNeeded)}</span>.
        </div>
        <div class="sim-sub">
          Basit hesaplama: AylÄ±k faiz oranÄ±nÄ± (varsa) kullanarak sabit taksit varsayÄ±mÄ± yapÄ±lÄ±r; gerÃ§ek bankanÄ±n hesabÄ±yla kÃ¼Ã§Ã¼k farklar olabilir.
        </div>
        <div class="sim-sub" style="margin-top:4px;">
          Tahmini toplam faiz yÃ¼kÃ¼: <span class="sim-highlight">${formatCurrency(totalInterest)}</span>.
        </div>
        <div class="sim-list">
          ${results.map(r => `
            <div class="sim-item">
              <div>
                <div class="sim-main">${r.debt.name}</div>
                <div class="sim-sub">
                  Mevcut min. Ã¶deme: ${formatCurrency(r.debt.monthlyPayment || 0)}
                  ${r.debt.interestRate ? ` â€¢ AylÄ±k faiz: ${r.debt.interestRate.toFixed(2).replace(".", ",")}%` : ""}
                </div>
              </div>
              <div style="text-align:right;">
                <div class="sim-main">${formatCurrency(r.monthlyPaymentNeeded)}</div>
                <div class="sim-sub">Gereken aylÄ±k Ã¶deme</div>
              </div>
            </div>
          `).join("")}
        </div>
      `;
    }

    // --- Avalanche Ã¶nerisi ---
    function renderAvalancheSuggestion() {
      const container = document.getElementById("avalancheResult");
      if (!container) return;

      const debtsWithBalance = state.debts.filter(d => (d.balance || 0) > 0);

      if (!debtsWithBalance.length) {
        container.style.display = "block";
        container.innerHTML = `<div class="sim-sub">Aktif borcun yok veya hepsinin bakiyesi 0 gÃ¶rÃ¼nÃ¼yor. ğŸ‰</div>`;
        return;
      }

      const sorted = debtsWithBalance.slice().sort((a, b) => {
        const ra = (b.interestRate || 0) - (a.interestRate || 0);
        if (ra !== 0) return ra;
        return (b.balance || 0) - (a.balance || 0);
      });

      const allZeroInterest = sorted.every(d => !d.interestRate);

      container.style.display = "block";
      container.innerHTML = `
        <div class="sim-main">
          Avalanche (faiz odaklÄ±) yÃ¶nteme gÃ¶re, <span class="sim-highlight">en yÃ¼ksek faiz oranlÄ± borÃ§tan</span>
          baÅŸlayarak ekstra Ã¶demeleri aÅŸaÄŸÄ±daki sÄ±rayla yapman mantÄ±klÄ±:
        </div>
        <div class="sim-list" style="margin-top:8px;">
          ${sorted.map((d, idx) => `
            <div class="sim-item">
              <div>
                <div class="sim-main">#${idx + 1} - ${d.name}</div>
                <div class="sim-sub">
                  Bakiye: ${formatCurrency(d.balance || 0)}
                  â€¢ Min. Ã¶deme: ${formatCurrency(d.monthlyPayment || 0)}
                  ${d.interestRate ? `â€¢ AylÄ±k faiz: ${d.interestRate.toFixed(2).replace(".", ",")}%` : "â€¢ Faiz oranÄ± belirtilmemiÅŸ (0% varsayÄ±ldÄ±)"}
                </div>
              </div>
              <div style="text-align:right;">
                <div class="sim-sub">TÃ¼r: ${getDebtTypeTag(d.type).text}</div>
              </div>
            </div>
          `).join("")}
        </div>
        <div class="sim-sub" style="margin-top:6px;">
          Not: Ã–nce listenin baÅŸÄ±ndaki borca mÃ¼mkÃ¼n olduÄŸunca fazla Ã¶deme yapÄ±p, sadece diÄŸer borÃ§lara minimum Ã¶demeleri yaparsan,
          toplam faiz yÃ¼kÃ¼nÃ¼ uzun vadede azaltmÄ±ÅŸ olursun.
          ${allZeroInterest ? "<br/>TÃ¼m faiz oranlarÄ± boÅŸ/0 gÃ¶rÃ¼ndÃ¼ÄŸÃ¼ iÃ§in sÄ±ralama bakiyeye gÃ¶re yapÄ±ldÄ±." : ""}
        </div>
      `;
    }

    // --- Event listener'lar ---
    document.addEventListener("DOMContentLoaded", () => {
      loadState();
      updateCurrentMonthLabel();

      // VarsayÄ±lan tarih
      const expenseDateInput = document.getElementById("expenseDate");
      expenseDateInput.value = todayISO();

      // Formlar
      document.getElementById("debtForm").addEventListener("submit", (e) => {
        e.preventDefault();
        upsertDebtFromForm();
      });

      document.getElementById("expenseForm").addEventListener("submit", (e) => {
        e.preventDefault();
        addExpenseFromForm();
      });

      document.getElementById("incomeForm").addEventListener("submit", (e) => {
        e.preventDefault();
        saveIncomeFromForm();
      });

      document.getElementById("termDepositForm").addEventListener("submit", (e) => {
        e.preventDefault();
        saveTermDepositFromForm();
      });

      document.getElementById("simForm").addEventListener("submit", (e) => {
        e.preventDefault();
        runSimulationFromForm();
      });

      // Harcama formu aÃ§/kapa
      const toggleBtn = document.getElementById("toggleExpenseFormBtn");
      const expenseContainer = document.getElementById("expenseFormContainer");
      const cancelExpenseBtn = document.getElementById("cancelExpenseBtn");

      function toggleExpenseForm(show) {
        const willShow = show !== undefined ? show : expenseContainer.style.display === "none";
        expenseContainer.style.display = willShow ? "block" : "none";
        toggleBtn.innerHTML = willShow
          ? '<span class="btn-icon">âœ–</span> HarÃ§ama eklemeyi kapat'
          : '<span class="btn-icon">â•</span> Yeni harcama yaptÄ±m';
        if (willShow) {
          document.getElementById("expenseDescription").focus();
        }
      }

      toggleBtn.addEventListener("click", () => toggleExpenseForm());
      cancelExpenseBtn.addEventListener("click", () => toggleExpenseForm(false));

      // Initial render
      document.getElementById("incomeInput").value = state.income || "";
      renderDebts();
      renderExpenses();
      renderTermDeposit();
    });
  </script>
</body>
</html>
